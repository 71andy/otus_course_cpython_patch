From 337fd33c5f42d6661059b61287d4f36004fe97d5 Mon Sep 17 00:00:00 2001
From: Andrey Mozzhevilov <71andy@mail.ru>
Date: Mon, 21 Mar 2022 05:15:51 +0000
Subject: [PATCH] inc_dec

---
 Grammar/Grammar    |  3 +++
 Include/token.h    |  4 +++-
 Parser/tokenizer.c |  8 ++++++--
 Python/ast.c       | 43 +++++++++++++++++++++++++++++++++++++++++++
 4 files changed, 55 insertions(+), 3 deletions(-)

diff --git a/Grammar/Grammar b/Grammar/Grammar
index 4c3f33d..9b43961 100644
--- a/Grammar/Grammar
+++ b/Grammar/Grammar
@@ -140,3 +140,6 @@ testlist1: test (',' test)*
 encoding_decl: NAME
 
 yield_expr: 'yield' [testlist]
+
+incr_stmt: '++'
+decr_stmt: '--'
\ No newline at end of file
diff --git a/Include/token.h b/Include/token.h
index 72659ac..827ac22 100644
--- a/Include/token.h
+++ b/Include/token.h
@@ -63,7 +63,9 @@ extern "C" {
 /* Don't forget to update the table _PyParser_TokenNames in tokenizer.c! */
 #define OP		51
 #define ERRORTOKEN	52
-#define N_TOKENS	53
+#define INCREMENT   53
+#define DECREMENT   54
+#define N_TOKENS	55
 
 /* Special definitions for cooperation with parser */
 
diff --git a/Parser/tokenizer.c b/Parser/tokenizer.c
index 8966661..d35bb48 100644
--- a/Parser/tokenizer.c
+++ b/Parser/tokenizer.c
@@ -88,8 +88,10 @@ char *_PyParser_TokenNames[] = {
     "AT",
     /* This table must match the #defines in token.h! */
     "OP",
-    "<ERRORTOKEN>",
-    "<N_TOKENS>"
+    "<ERRORTOKN>",
+    "INCREMENT",
+    "DECREMENT"
+    "<N_TOKENS>",
 };
 
 /* Create and initialize a new tok_state structure */
@@ -1107,11 +1109,13 @@ PyToken_TwoChars(int c1, int c2)
         break;
     case '+':
         switch (c2) {
+        case '+':               return INCREMENT;
         case '=':               return PLUSEQUAL;
         }
         break;
     case '-':
         switch (c2) {
+        case '-':               return DECREMENT;
         case '=':               return MINEQUAL;
         }
         break;
diff --git a/Python/ast.c b/Python/ast.c
index 10571a3..532ac71 100644
--- a/Python/ast.c
+++ b/Python/ast.c
@@ -2229,6 +2229,49 @@ ast_for_expr_stmt(struct compiling *c, const node *n)
         return AugAssign(expr1, newoperator, expr2, LINENO(n), n->n_col_offset,
                          c->c_arena);
     }
+    else if ((TYPE(CHILD(n, 1)) == incr_stmt) || (TYPE(CHILD(n, 1)) == decr_stmt)) {
+        expr_ty expr1, expr2;
+        node *ch = CHILD(n, 0);
+        operator_ty operator;
+        
+        switch (TYPE(CHILD(n, 1))){
+            case incr_stmt:
+                operator = Add; 
+                break;
+            case decr_stmt:
+                operator = Sub; 
+                break;
+        }
+
+        expr1 = ast_for_testlist(c, ch);
+        if (!expr1) 
+            return NULL;
+        
+        if(!set_context(c, expr1, Store, ch))
+            return NULL;
+
+        switch (expr1->kind) {
+            case Name_kind:
+                if (forbidden_check(c, n, STR(n))) {
+                    return NULL;
+                }
+                expr1->v.Name.ctx = Store;
+                break;
+            default:
+                ast_error(ch, "illegal target for increment/decrement");
+                return NULL;
+        }
+        // Create a PyObject for the number 1
+        PyObject *pynum = parsenumber(c, "1");
+
+        if (PyArena_AddPyObject(c->c_arena, pynum) < 0) {
+            Py_DECREF(pynum);
+            return NULL;
+        }
+        // Create that as an expression on the same line and offset as the ++/--
+        expr2 = Num(pynum, LINENO(n), n->n_col_offset, c->c_arena);
+        return AugAssign(expr1, operator, expr2, LINENO(n), n->n_col_offset, c->c_arena);
+    }
     else {
         int i;
         asdl_seq *targets;
-- 
1.8.3.1

